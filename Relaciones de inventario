SELECT 
    SUBSTRING(CI.NOMBRE_ABREV FROM 1 FOR POSITION(' ' IN CI.NOMBRE_ABREV || ' ') - 1) AS NUMERO_SERIE,
    GL.NOMBRE AS GRUPO,
    L.NOMBRE AS LINEA,
    A.NOMBRE AS DESCRIPCION,
    A.UNIDAD_COMPRA AS U_MED,
    SUM(D.UNIDADES) AS UNIDADES_TOTALES,
    SUM(D.COSTO_TOTAL) / NULLIF(SUM(D.UNIDADES), 0) AS COSTO_UNITARIO_PROM,
    SUM(D.COSTO_TOTAL) AS COSTO_TOTAL
FROM 
    DOCTOS_IN_DET D
    JOIN ARTICULOS A ON A.ARTICULO_ID = D.ARTICULO_ID
    LEFT JOIN LINEAS_ARTICULOS L ON L.LINEA_ARTICULO_ID = A.LINEA_ARTICULO_ID
    LEFT JOIN GRUPOS_LINEAS GL ON GL.GRUPO_LINEA_ID = L.GRUPO_LINEA_ID
    JOIN DOCTOS_IN I ON I.DOCTO_IN_ID = D.DOCTO_IN_ID
    JOIN CONCEPTOS_IN CI ON CI.CONCEPTO_IN_ID = I.CONCEPTO_IN_ID
WHERE 
    D.CANCELADO <> 'S'
    AND I.FECHA BETWEEN '2000-01-01' AND '2025-04-30'
    AND D.ALMACEN_ID = 100
    AND CI.NOMBRE_ABREV SIMILAR TO '5[0-9]%'  -- Solo los que empiezan con 5
GROUP BY 
    NUMERO_SERIE, GL.NOMBRE, L.NOMBRE, A.NOMBRE, A.UNIDAD_COMPRA
ORDER BY 
    NUMERO_SERIE, GL.NOMBRE, L.NOMBRE, A.NOMBRE;

